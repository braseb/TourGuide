image: maven:3.9.9-eclipse-temurin-17

stages:
  - install
  - compile
  - test
  - build

#variables:
#  MAVEN_USER_HOME: "$CI_PROJECT_DIR/.m2"
variables:
  MAVEN_OPTS: "-Dmaven.repo.local=$CI_PROJECT_DIR/.m2/repository"

# Cache Maven
cache:
  key: ${CI_COMMIT_REF_SLUG}
  paths:
    - .m2/repository/

# Stage 1 : Install local library'
install_local_libs:
  stage: install
  script:
    - cd TourGuide
    - mvn install:install-file -Dfile=libs/gpsUtil.jar -DgroupId=gpsUtil -DartifactId=gpsUtil -Dversion=1.0.0 -Dpackaging=jar
    - mvn install:install-file -Dfile=libs/RewardCentral.jar -DgroupId=rewardCentral -DartifactId=rewardCentral -Dversion=1.0.0 -Dpackaging=jar
    - mvn install:install-file -Dfile=libs/TripPricer.jar -DgroupId=tripPricer -DartifactId=tripPricer -Dversion=1.0.0 -Dpackaging=jar
  artifacts:
    paths:
      - .m2/repository/
    expire_in: 1 hour
  
# Stage 2 : Compile
compile:
  stage: compile
  script:
    - cd TourGuide
    - mvn -B -DskipTests clean compile
  artifacts:
    paths:
      - TourGuide/target/
    expire_in: 1 hour
 
# Stage 3 : Launch tests
test:
  stage: test
  dependencies:
    - compile
  script:
    - cd TourGuide
    - mvn test
  artifacts:
    when: always
    reports:
      junit: TourGuide/target/surefire-reports/*.xml

# Stage 4 : Build Jar
build:
  stage: build
  dependencies:
    - compile
  script:
    - cd TourGuide
    - mvn -Dmaven.test.skip=true package
  artifacts:
    paths:
      - TourGuide/target/*.jar
    expire_in: never
